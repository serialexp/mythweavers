import{render as y,createComponent as m}from"solid-js/web";import*as u from"virtual:$histoire-generated-global-setup";import*as c from"virtual:$histoire-setup";import{defineComponent as h,h as g,ref as w,watch as S,onMounted as x,onUnmounted as v}from"@histoire/vendors/vue";import M from"prettier/plugins/estree";import C from"prettier/plugins/typescript";import{format as V}from"prettier/standalone";import{MountStoryWithContext as b,MountVariant as W,MountStory as H}from"./components.js";async function P(t){try{let e=await V(t,{parser:"typescript",plugins:[C,M],printWidth:50,tabWidth:2,useTabs:!1,semi:!1,singleQuote:!0,jsxSingleQuote:!1,singleAttributePerLine:!0});return e=e.trim(),e.startsWith(";")&&(e=e.slice(1).trim()),e}catch(e){return console.warn("[histoire-plugin-solid] Prettier formatting failed:",e),t.trim()}}async function T(t){var o;const e=(o=t.file)==null?void 0:o.source;if(e)try{const s=(await e()).default;for(const i of t.variants){const n=await E(s,i.title);n&&(i.source=n)}}catch(r){console.warn("[histoire-plugin-solid] Failed to extract variant sources:",r)}}async function E(t,e){const o=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),r=new RegExp(`<Hst\\.Variant[^>]*title=["']${o}["'][^>]*>`,"s"),s=t.match(r);if(!s)return null;const i=s.index+s[0].length;let n=1,a=i;const l=t.slice(i),d=/<Hst\.Variant[^>]*>|<\/Hst\.Variant>/g;let f;for(;(f=d.exec(l))!==null;)if(f[0].startsWith("</")){if(n--,n===0){a=i+f.index;break}}else n++;if(n!==0)return null;const p=t.slice(i,a).trim();return P(p)}const k=h({name:"MountStory",props:{story:{type:Object,required:!0}},setup(t){const e=w();let o=null,r=null;async function s(){var n;if(r=document.createElement("div"),(n=e.value)==null||n.appendChild(r),await T(t.story),o=y(()=>{var l;const a=(l=t.story.file)==null?void 0:l.component;return a?m(b,{get story(){return t.story},get children(){return m(a,{Hst:{Story:H,Variant:W}})}}):null},r),typeof(u==null?void 0:u.setupSolid)=="function"){const a=u.setupSolid;await a({story:t.story,variant:null})}if(typeof(c==null?void 0:c.setupSolid)=="function"){const a=c.setupSolid;await a({story:t.story,variant:null})}}function i(){var n;o==null||o(),o=null,r&&((n=r.parentNode)==null||n.removeChild(r),r=null)}return S(()=>t.story.id,async()=>{i(),await s()}),x(async()=>{await s()}),v(()=>{i()}),{el:e}},render(){return g("div",{ref:"el"})}});export{k as default};
